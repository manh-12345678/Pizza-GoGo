<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pizza Menu - Bàn <span th:text="${table != null ? table.tableNumber : 'N/A'}"></span></title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #121212; color: #fff; padding: 20px; margin: 0; }
        h1 { text-align: center; color: #ff6a00; margin-bottom: 20px; font-size: 2.2em; text-transform: uppercase; letter-spacing: 2px; }
        .menu-section { margin-bottom: 40px; }
        .product-card { background: #1c1c1c; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: all 0.3s; }
        .product-card:hover { border-color: #ff6a00; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255, 106, 0, 0.3); }
        .product-img { width: 100%; height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }
        .order-items { margin-top: 40px; padding: 20px; border-radius: 12px; background: #1c1c1c; border: 1px solid #333; position: sticky; top: 20px; max-height: 80vh; overflow-y: auto; }
        .order-item { border-bottom: 1px solid #333; padding: 8px 0; }
        .d-flex { display: flex; justify-content: space-between; align-items: flex-start; }
        .text-end { text-align: right; }
        .ms-4 { margin-left: 1.5rem; }
        .text-success { color: #28a745 !important; }
        .text-muted { color: #aaa !important; }
        .text-info { color: #17a2b8 !important; }
        .text-warning { color: #ffc107 !important; }
        .border-top { border-top: 1px solid #444 !important; }
        .empty-message { font-style: italic; color: #aaa; }
        .category-title { color: #ff6a00; font-size: 1.5em; margin: 20px 0 15px 0; border-bottom: 2px solid #ff6a00; padding-bottom: 10px; }
        .topping-checkbox { margin: 5px 0; }
        .topping-list { max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #2c2c2c; border-radius: 4px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <h1>Menu Pizza - Bàn <span th:text="${table != null ? table.tableNumber : 'N/A'}"></span></h1>

    <div th:if="${error != null}" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
    </div>

    <div class="row">
        <!-- Menu Section -->
        <div class="col-lg-8">
            <div th:each="category : ${categories}" class="menu-section">
                <h2 class="category-title" th:text="${category}"></h2>
                <div class="row">
                    <div th:each="product : ${productsByCategory.get(category)}" class="col-md-6 col-lg-4 mb-3">
                        <div class="product-card">
                            <img th:src="${product.imgUrl != null ? product.imgUrl : '/images/pizza-1.jpg'}" 
                                 alt="Product" class="product-img" 
                                 th:onerror="this.src='/images/pizza-1.jpg'">
                            <h5 th:text="${product.name}"></h5>
                            <p class="text-muted small" th:text="${product.description}"></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-warning h5 mb-0" 
                                      th:text="${#numbers.formatInteger(product.price, 0, 'DEFAULT')} + '₫'"></span>
                                <button class="btn btn-primary btn-sm" 
                                        th:onclick="'addToCart(' + ${product.productId} + ', ' + ${order != null ? order.orderId : 0} + ')'"
                                        th:disabled="${order == null}">
                                    <i class="bi bi-cart-plus"></i> Thêm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cart Section -->
        <div class="col-lg-4">
            <div class="order-items">
                <h3 class="mb-3"><i class="bi bi-cart"></i> Giỏ hàng</h3>
                <div id="order-list">
                    <th:block th:replace="~{orders/choose_menu :: orderListFragment(${order})}"></th:block>
                </div>
                <div class="mt-3" th:if="${order != null}">
                    <a th:href="@{/orders/cart/{orderId}(orderId=${order.orderId})}" 
                       class="btn btn-warning w-100">
                        <i class="bi bi-cart-check"></i> Xem giỏ hàng
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #1c1c1c; color: #fff;">
            <div class="modal-header" style="border-bottom: 1px solid #333;">
                <h5 class="modal-title">Thêm vào giỏ hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalProductId">
                <input type="hidden" id="modalOrderId">
                <div class="mb-3">
                    <label class="form-label">Số lượng</label>
                    <input type="number" id="productQuantity" class="form-control" value="1" min="1" style="background: #2c2c2c; color: #fff; border: 1px solid #444;">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú (tùy chọn)</label>
                    <textarea id="productNote" class="form-control" rows="2" style="background: #2c2c2c; color: #fff; border: 1px solid #444;"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Topping (tùy chọn)</label>
                    <div id="toppingsContainer" class="topping-list">
                        <div class="text-center text-muted">Đang tải...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #333;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddToCart()">
                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order List Fragment -->
<th:block th:fragment="orderListFragment(order)">
    <div th:each="item : ${order?.orderDetails != null ? order.orderDetails : {}}"
         th:if="${order != null and (item.isDeleted == null or !item.isDeleted)}"
         class="order-item">
        <div class="d-flex">
            <div style="flex: 1;">
                <strong th:text="${item.product.name}"></strong>
                <small class="text-muted" th:text="'x' + ${item.quantity}"></small>
                <span th:if="${item.note}" class="text-info small d-block" th:text="'— ' + ${item.note}"></span>
            </div>
            <div class="text-end">
                <strong th:text="${#numbers.formatInteger(item.unitPrice.multiply(T(java.math.BigDecimal).valueOf(item.quantity.longValue())), 0, 'DEFAULT')} + '₫'"></strong>
            </div>
        </div>
        <div th:each="odt : ${item.orderDetailToppings}"
             th:if="${odt.isDeleted == null or !odt.isDeleted}"
             class="ms-4 mt-1 text-success small">
            + <span th:text="${odt.topping.name}"></span>
            (<span th:text="${#numbers.formatInteger(odt.topping.price, 0, 'DEFAULT')} + '₫'"></span>)
        </div>
    </div>

    <div th:if="${order != null and (order?.orderDetails == null or #lists.isEmpty(order?.orderDetails.?[isDeleted == null or !isDeleted]))}">
        <p class="empty-message">Giỏ hàng của bạn đang trống.</p>
    </div>

    <div class="mt-4 pt-3 border-top" th:if="${order != null}">
        <div class="d-flex justify-content-between">
            <strong class="h5 mb-0">Tổng cộng:</strong>
            <strong class="text-warning h5 mb-0"
                    th:text="${order?.totalAmount != null ? (#numbers.formatInteger(order.totalAmount, 0, 'DEFAULT') + '₫') : '0₫'}"></strong>
        </div>
    </div>
</th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const tableId = [[${table != null ? table.tableId : 0}]];
    const orderId = [[${order != null ? order.orderId : 0}]];
    let stompClient = null;
    let availableToppings = [];

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/orders/' + tableId, (msg) => {
                const orderList = document.getElementById('order-list');
                if (orderList) {
                    orderList.innerHTML = msg.body;
                }
            });
        }, () => setTimeout(connect, 3000));
    }

    function addToCart(productId, orderId) {
        document.getElementById('modalProductId').value = productId;
        document.getElementById('modalOrderId').value = orderId;
        document.getElementById('productQuantity').value = 1;
        document.getElementById('productNote').value = '';
        
        // Load toppings for this product
        const toppingsContainer = document.getElementById('toppingsContainer');
        toppingsContainer.innerHTML = '<div class="text-center text-muted">Đang tải...</div>';
        
        fetch(`/orders/products/${productId}/toppings`)
            .then(response => response.json())
            .then(toppings => {
                availableToppings = toppings;
                if (toppings.length === 0) {
                    toppingsContainer.innerHTML = '<div class="text-muted small">Không có topping nào</div>';
                } else {
                    toppingsContainer.innerHTML = toppings.map(t => `
                        <div class="form-check topping-checkbox">
                            <input class="form-check-input" type="checkbox" value="${t.toppingId}" id="topping_${t.toppingId}">
                            <label class="form-check-label" for="topping_${t.toppingId}">
                                ${t.name} (+${formatCurrency(t.price)})
                            </label>
                        </div>
                    `).join('');
                }
            })
            .catch(error => {
                console.error('Error loading toppings:', error);
                toppingsContainer.innerHTML = '<div class="text-danger small">Lỗi khi tải toppings</div>';
            });
        
        new bootstrap.Modal(document.getElementById('addProductModal')).show();
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
    }

    function confirmAddToCart() {
        const productId = document.getElementById('modalProductId').value;
        const orderId = document.getElementById('modalOrderId').value;
        const quantity = document.getElementById('productQuantity').value;
        const note = document.getElementById('productNote').value;

        if (!productId || !orderId || !quantity) {
            alert('Vui lòng nhập đầy đủ thông tin!');
            return;
        }

        // Add product first (without toppings)
        let body = `orderId=${orderId}&productId=${productId}&quantity=${quantity}`;
        if (note) {
            body += `&note=${encodeURIComponent(note)}`;
        }

        fetch('/orders/add-product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body
        })
        .then(response => response.text())
        .then(result => {
            if (result === 'success') {
                // Get selected toppings
                const selectedToppings = Array.from(document.querySelectorAll('#toppingsContainer input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                if (selectedToppings.length > 0) {
                    // Fetch updated order to get the latest orderDetailId
                    return fetch(`/orders/search?orderId=${orderId}`)
                        .then(response => response.json())
                        .then(orders => {
                            if (orders.length > 0) {
                                const order = orders[0];
                                // Get the last orderDetail (most recently added)
                                if (order.items && order.items.length > 0) {
                                    const lastItem = order.items[order.items.length - 1];
                                    const orderDetailId = lastItem.orderDetailId;
                                    
                                    // Add toppings one by one
                                    const addToppingPromises = selectedToppings.map(toppingId => {
                                        return fetch(`/orders/orderdetails/${orderDetailId}/add-topping?toppingId=${toppingId}`, {
                                            method: 'POST'
                                        }).then(response => response.text());
                                    });
                                    return Promise.all(addToppingPromises);
                                }
                            }
                            return Promise.resolve();
                        });
                }
                return Promise.resolve();
            } else {
                alert('Lỗi: ' + result);
                return Promise.reject(result);
            }
        })
        .then(() => {
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            // WebSocket will update the cart automatically
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            alert('Lỗi khi thêm vào giỏ hàng!');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        connect();
    });
    /*]]>*/
</script>
</body>
</html>
