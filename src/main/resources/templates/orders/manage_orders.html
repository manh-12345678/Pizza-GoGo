<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{manager/fragments/layout :: managerHead('Quản lý đơn hàng', ~{::extraHead})}">
    <th:block th:fragment="extraHead">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        <style>
            .order-card { border-left: 4px solid #007bff; margin-bottom: 15px; }
            .order-card.pending { border-left-color: #ffc107; }
            .order-card.processing { border-left-color: #17a2b8; }
            .order-card.completed { border-left-color: #28a745; }
            .order-card.cancelled { border-left-color: #dc3545; }
            .order-item { border-bottom: 1px solid #dee2e6; padding: 10px 0; }
            .order-item:last-child { border-bottom: none; }
            .topping-item { margin-left: 20px; color: #28a745; font-size: 0.9em; }
            .order-details { max-height: 400px; overflow-y: auto; }
            .collapse-btn { cursor: pointer; }
            .topping-list { max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        </style>
    </th:block>
</head>
<body>
<div th:replace="~{manager/fragments/layout :: managerLayout('orders', ~{::pageContent})}">
    <div th:fragment="pageContent">
        <div class="container-fluid px-0">
            <h2 class="mb-4"><i class="bi bi-receipt"></i> Quản lý đơn hàng</h2>

            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="row g-2 g-md-3 align-items-center">
                        <div class="col-md-4">
                            <input type="number" id="searchOrderId" class="form-control" placeholder="Tìm theo ID đơn">
                        </div>
                        <div class="col-md-4">
                            <input type="number" id="searchTableNumber" class="form-control" placeholder="Tìm theo số bàn">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="searchOrders()">
                                <i class="bi bi-search"></i> Tìm kiếm
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-secondary w-100" onclick="loadOrders('')">
                                <i class="bi bi-arrow-clockwise"></i> Làm mới
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="btn-group flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="filterOrders('')">Tất cả</button>
                                <button type="button" class="btn btn-outline-warning" onclick="filterOrders('PENDING')">Chờ xử lý</button>
                                <button type="button" class="btn btn-outline-info" onclick="filterOrders('PROCESSING')">Đang xử lý</button>
                                <button type="button" class="btn btn-outline-success" onclick="filterOrders('COMPLETED')">Hoàn thành</button>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-2 mt-md-0">
                            <button type="button" class="btn btn-success" onclick="showCreateOrderModal()">
                                <i class="bi bi-plus-circle"></i> Tạo đơn mới
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orders-container">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo đơn mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select id="tableSelect" class="form-select">
                    <option value="">-- Chọn bàn --</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">Tạo đơn</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm món vào đơn <span id="addProductOrderId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select id="productSelect" class="form-select mb-3">
                    <option value="">-- Chọn món --</option>
                </select>
                <input type="number" id="productQuantity" class="form-control mb-3" value="1" min="1" placeholder="Số lượng">
                <textarea id="productNote" class="form-control" placeholder="Ghi chú (tùy chọn)"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="addProductToOrder()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addToppingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm topping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalOrderDetailId">
                <div id="toppingsContainer" class="topping-list">
                    <div class="text-center text-muted">Đang tải...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="addToppingToOrderDetail()">Thêm</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{manager/fragments/layout :: managerScripts(~{::extraScripts})}"></th:block>
<th:block th:fragment="extraScripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        let stompClient = null;
        let currentStatus = '';
        let currentOrderId = null;
        let currentOrderDetailId = null;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                stompClient.subscribe('/topic/orders/update', (msg) => {
                    console.log('Order updated:', msg.body);
                    loadOrders(currentStatus);
                });
            }, () => setTimeout(connect, 3000));
        }

        function loadOrders(status = '') {
            currentStatus = status;
            const url = status ? `/manager/orders/list?status=${status}` : '/manager/orders/list';
            fetch(url)
                .then(response => response.json())
                .then(orders => {
                    const container = document.getElementById('orders-container');
                    if (orders.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">Không có đơn hàng nào.</div>';
                        return;
                    }
                    container.innerHTML = orders.map(order => renderOrder(order)).join('');
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    document.getElementById('orders-container').innerHTML =
                        '<div class="alert alert-danger">Lỗi khi tải danh sách đơn hàng.</div>';
                });
        }

        function renderOrder(order) {
            const statusColor = getStatusColor(order.status);
            const statusBadge = `<span class="badge bg-${statusColor}">${order.status}</span>`;
            const items = order.items ? order.items.map(item => renderOrderItem(item, order.orderId)).join('') : '';

            let paymentInfoHtml = '';
            if (order.paymentInfo) {
                const payment = order.paymentInfo;
                const paymentStatusColor = payment.status === 'COMPLETED' ? 'success' :
                    payment.status === 'PENDING' ? 'warning' :
                        payment.status === 'FAILED' ? 'danger' : 'secondary';
                const paymentStatusText = payment.status === 'COMPLETED' ? 'Đã thanh toán' :
                    payment.status === 'PENDING' ? 'Chờ xử lý' :
                        payment.status === 'FAILED' ? 'Thất bại' : payment.status;
                paymentInfoHtml = `
                    <div class="payment-info ${payment.status.toLowerCase()} mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="bi bi-credit-card-2-front"></i> Phương thức thanh toán:</strong>
                                ${payment.paymentMethod === 'COD' ?
                                    '<span class="badge bg-info ms-2"><i class="bi bi-cash-coin"></i> COD (Thanh toán khi nhận hàng)</span>' :
                                    '<span class="badge bg-warning ms-2"><i class="bi bi-credit-card"></i> VNPAY</span>'}
                                <span class="badge bg-${paymentStatusColor} ms-2">${paymentStatusText}</span>
                                <span class="ms-2 fw-bold text-success">${formatCurrency(payment.amount)}</span>
                            </div>
                            ${payment.status === 'PENDING' && payment.paymentMethod === 'COD' ? `
                                <button class="btn btn-sm btn-success" onclick="confirmCODPayment(${order.orderId}, ${payment.paymentId})">
                                    <i class="bi bi-check-circle"></i> Duyệt COD
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="card order-card ${order.status.toLowerCase()} shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-2">Đơn #${order.orderId}</h5>
                                <p class="mb-1"><strong><i class="bi bi-table"></i> Bàn:</strong> ${order.tableName || 'N/A'}</p>
                                <p class="mb-1"><strong><i class="bi bi-clock"></i> Thời gian:</strong> ${order.time || 'N/A'}</p>
                                <p class="mb-0"><strong><i class="bi bi-cash-coin"></i> Tổng:</strong>
                                    <span class="text-success fw-bold">${formatCurrency(order.totalAmount)}</span>
                                </p>
                            </div>
                            <div>
                                ${statusBadge}
                            </div>
                        </div>

                        ${paymentInfoHtml}

                        <div class="mb-3">
                            <h6 class="collapse-btn" data-bs-toggle="collapse" data-bs-target="#orderDetails_${order.orderId}">
                                <i class="bi bi-chevron-down"></i> Chi tiết đơn (${order.items ? order.items.length : 0} món)
                            </h6>
                            <div class="collapse show order-details" id="orderDetails_${order.orderId}">
                                ${items || '<p class="text-muted">Chưa có món nào</p>'}
                            </div>
                        </div>

                        <div class="btn-group flex-wrap" role="group">
                            <button class="btn btn-sm btn-primary" onclick="showAddProductModal(${order.orderId})">
                                <i class="bi bi-plus"></i> Thêm món
                            </button>
                            ${(order.status === 'PENDING' || order.status === 'PROCESSING') ? `
                                <button class="btn btn-sm btn-info" onclick="updateStatus(${order.orderId}, 'PROCESSING')" ${order.status === 'PROCESSING' ? 'disabled' : ''}>
                                    <i class="bi bi-play"></i> Bắt đầu
                                </button>
                                <button class="btn btn-sm btn-success" onclick="updateStatus(${order.orderId}, 'COMPLETED')" ${order.status === 'COMPLETED' ? 'disabled' : ''}>
                                    <i class="bi bi-check"></i> Hoàn thành
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="initiatePayment(${order.orderId})" title="Thanh toán VNPAY">
                                    <i class="bi bi-credit-card"></i> VNPAY
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="cancelOrder(${order.orderId})">
                                    <i class="bi bi-x"></i> Hủy
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOrderItem(item, orderId) {
            const toppings = item.toppings ? item.toppings.map(t =>
                `<div class="topping-item">
                    + ${t.name} (${formatCurrency(t.price)})
                    <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="deleteTopping(${orderId}, ${t.toppingId})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>`
            ).join('') : '';

            return `
                <div class="order-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${item.productName}</strong> x${item.quantity}
                            ${item.note ? `<br><small class="text-muted">Ghi chú: ${item.note}</small>` : ''}
                            ${toppings}
                        </div>
                        <div class="text-end">
                            <div>${formatCurrency(item.subtotal)}</div>
                            <button class="btn btn-sm btn-danger mt-1" onclick="deleteProduct(${orderId}, ${item.orderDetailId})">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-success mt-1" onclick="showAddToppingModal(${item.orderDetailId}, ${item.productId})" ${!item.productId ? 'disabled' : ''}>
                                <i class="bi bi-plus"></i> Topping
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterOrders(status) {
            loadOrders(status);
        }

        function searchOrders() {
            const orderId = document.getElementById('searchOrderId').value;
            const tableNumber = document.getElementById('searchTableNumber').value;
            let url = '/manager/orders/search?';
            if (orderId) url += `orderId=${orderId}&`;
            if (tableNumber) url += `tableNumber=${tableNumber}`;

            fetch(url)
                .then(response => response.json())
                .then(orders => {
                    const container = document.getElementById('orders-container');
                    if (orders.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">Không tìm thấy đơn hàng nào.</div>';
                        return;
                    }
                    container.innerHTML = orders.map(order => renderOrder(order)).join('');
                })
                .catch(error => {
                    console.error('Error searching orders:', error);
                    document.getElementById('orders-container').innerHTML =
                        '<div class="alert alert-danger">Lỗi khi tìm kiếm đơn hàng.</div>';
                });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }

        function getStatusColor(status) {
            const colors = {
                'PENDING': 'warning',
                'PROCESSING': 'info',
                'COMPLETED': 'success',
                'CANCELLED': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function showCreateOrderModal() {
            fetch('/manager/orders/tables')
                .then(response => response.json())
                .then(tables => {
                    const select = document.getElementById('tableSelect');
                    select.innerHTML = '<option value="">-- Chọn bàn --</option>' +
                        tables.map(t => `<option value="${t.tableId}">${t.tableName}</option>`).join('');
                    new bootstrap.Modal(document.getElementById('createOrderModal')).show();
                });
        }

        function createOrder() {
            const tableId = document.getElementById('tableSelect').value;
            if (!tableId) {
                alert('Vui lòng chọn bàn!');
                return;
            }
            fetch('/manager/orders/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `tableId=${tableId}`
            })
                .then(response => response.json())
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('createOrderModal')).hide();
                    loadOrders(currentStatus);
                })
                .catch(error => {
                    console.error('Error creating order:', error);
                    alert('Lỗi khi tạo đơn hàng!');
                });
        }

        function showAddProductModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('addProductOrderId').textContent = '#' + orderId;
            fetch('/manager/orders/products')
                .then(response => response.json())
                .then(products => {
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">-- Chọn món --</option>' +
                        products.map(p => `<option value="${p.productId}">${p.name} - ${formatCurrency(p.price)}</option>`).join('');
                    new bootstrap.Modal(document.getElementById('addProductModal')).show();
                });
        }

        function addProductToOrder() {
            const productId = document.getElementById('productSelect').value;
            const quantity = document.getElementById('productQuantity').value;
            const note = document.getElementById('productNote').value;

            if (!productId || !quantity) {
                alert('Vui lòng chọn món và nhập số lượng!');
                return;
            }

            let body = `productId=${productId}&quantity=${quantity}`;
            if (note) body += `&note=${encodeURIComponent(note)}`;

            fetch(`/manager/orders/${currentOrderId}/add-product`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body
            })
                .then(response => response.json())
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadOrders(currentStatus);
                })
                .catch(error => {
                    console.error('Error adding product:', error);
                    alert('Lỗi khi thêm món!');
                });
        }

        function showAddToppingModal(orderDetailId, productId) {
            currentOrderDetailId = orderDetailId;
            document.getElementById('modalOrderDetailId').value = orderDetailId;

            const toppingsContainer = document.getElementById('toppingsContainer');
            toppingsContainer.innerHTML = '<div class="text-center text-muted">Đang tải...</div>';

            fetch(`/orders/products/${productId}/toppings`)
                .then(response => response.json())
                .then(toppings => {
                    if (toppings.length === 0) {
                        toppingsContainer.innerHTML = '<div class="text-muted small">Không có topping nào</div>';
                    } else {
                        toppingsContainer.innerHTML = toppings.map(t => `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${t.toppingId}" id="topping_${t.toppingId}">
                                <label class="form-check-label" for="topping_${t.toppingId}">
                                    ${t.name} (+${formatCurrency(t.price)})
                                </label>
                            </div>
                        `).join('');
                    }
                    new bootstrap.Modal(document.getElementById('addToppingModal')).show();
                })
                .catch(error => {
                    console.error('Error loading toppings:', error);
                    toppingsContainer.innerHTML = '<div class="text-danger small">Lỗi khi tải toppings</div>';
                });
        }

        function addToppingToOrderDetail() {
            const selectedToppings = Array.from(document.querySelectorAll('#toppingsContainer input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedToppings.length === 0) {
                alert('Vui lòng chọn ít nhất một topping!');
                return;
            }

            const addToppingPromises = selectedToppings.map(toppingId => {
                return fetch(`/manager/orders/${currentOrderDetailId}/add-topping?toppingId=${toppingId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                }).then(response => response.json());
            });

            Promise.all(addToppingPromises)
                .then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addToppingModal')).hide();
                    loadOrders(currentStatus);
                })
                .catch(error => {
                    console.error('Error adding toppings:', error);
                    alert('Lỗi khi thêm topping!');
                });
        }

        function updateStatus(orderId, status) {
            fetch(`/manager/orders/${orderId}/status?status=${status}`, {
                method: 'POST'
            })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        loadOrders(currentStatus);
                    } else {
                        alert('Lỗi: ' + result);
                    }
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                    alert('Lỗi khi cập nhật trạng thái!');
                });
        }

        function cancelOrder(orderId) {
            if (!confirm('Bạn có chắc chắn muốn hủy đơn này?')) return;

            fetch(`/manager/orders/${orderId}/cancel`, {
                method: 'POST'
            })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        loadOrders(currentStatus);
                    } else {
                        alert('Lỗi: ' + result);
                    }
                })
                .catch(error => {
                    console.error('Error cancelling order:', error);
                    alert('Lỗi khi hủy đơn!');
                });
        }

        function deleteProduct(orderId, orderDetailId) {
            if (!confirm('Bạn có chắc chắn muốn xóa món này?')) return;

            fetch(`/manager/orders/${orderId}/delete-product?orderDetailId=${orderDetailId}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(() => {
                    loadOrders(currentStatus);
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    alert('Lỗi khi xóa món!');
                });
        }

        function deleteTopping(orderId, toppingId) {
            if (!confirm('Bạn có chắc chắn muốn xóa topping này?')) return;

            fetch(`/manager/orders/${orderId}/delete-topping?toppingId=${toppingId}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(() => {
                    loadOrders(currentStatus);
                })
                .catch(error => {
                    console.error('Error deleting topping:', error);
                    alert('Lỗi khi xóa topping!');
                });
        }

        function confirmCODPayment(orderId, paymentId) {
            if (!confirm('Xác nhận thanh toán COD cho đơn hàng này?')) {
                return;
            }

            const formData = new URLSearchParams();
            formData.append('paymentId', paymentId);

            fetch(`/manager/orders/${orderId}/confirm-cod-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'Đã xác nhận thanh toán COD thành công!');
                        loadOrders(currentStatus);
                    } else {
                        alert('Lỗi: ' + (data.message || 'Không thể xác nhận thanh toán COD'));
                    }
                })
                .catch(error => {
                    console.error('Error confirming COD payment:', error);
                    alert('Lỗi khi xác nhận thanh toán COD!');
                });
        }

        function initiatePayment(orderId) {
            if (!confirm('Bạn có chắc chắn muốn thanh toán đơn hàng này qua VNPAY?')) {
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/payment/create';

            const orderIdInput = document.createElement('input');
            orderIdInput.type = 'hidden';
            orderIdInput.name = 'orderId';
            orderIdInput.value = orderId;

            form.appendChild(orderIdInput);
            document.body.appendChild(form);
            form.submit();
        }

        document.addEventListener('DOMContentLoaded', () => {
            connect();
            loadOrders();
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>
