<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quản Lý Đơn Hàng - Admin Dashboard</title>

    <!-- Optional: Spring CSRF token (server thường inject vào layout tự động) -->
    <!-- <meta name="_csrf" content="${_csrf.token}" />
    <meta name="_csrf_header" content="${_csrf.headerName}" /> -->

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- Theme variables --- */
        :root{
            --bg-body: #0d0d0d;
            --bg-darker: #1a1a1a;
            --muted: #9ca3af;
            --primary: #8b5cf6;
            --border: #2d2d2d;
            --card: #252525;
            --text: #f2f2f2;
        }

        body{
            background: var(--bg-body);
            color: var(--text);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 0;
            height: 100vh;
        }

        .d-flex { display:flex; }
        .flex-column { flex-direction: column; }
        .flex-grow-1 { flex:1; }

        /* Sidebar */
        .sidebar{
            width: 256px;
            background: var(--bg-darker);
            border-right: 1px solid var(--border);
            display:flex;
            flex-direction:column;
            overflow-y:auto;
        }

        .sidebar .p-4 { padding:1rem; }
        .nav-link { color: var(--muted); text-decoration:none; display:flex; align-items:center; gap:12px; border-radius:8px; padding:0.75rem; }
        .nav-link:hover { background: #2d2d2d; color:var(--text); }
        .nav-link.active { background: var(--primary); color:#fff; }

        .avatar{ width:40px; height:40px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:var(--primary); color:#fff; }

        /* Main content */
        main { padding:1rem; gap:16px; display:flex; align-items:flex-start; overflow:hidden; }

        /* Orders grid */
        .orders-grid { overflow-y:auto; padding-right:8px; }
        .card-order {
            background: var(--bg-darker);
            border: 1px solid var(--border);
            border-radius:12px;
            padding:16px;
            transition: all .18s ease;
            cursor:pointer;
        }

        .card-order:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.45); border-color: var(--primary); background: var(--card); }
        .card-order.selected { border-color: var(--primary); background: var(--card); box-shadow: 0 12px 32px rgba(139,92,246,0.12); }

        .badge { font-weight:600; padding:0.3rem 0.6rem; border-radius:8px; }
        .badge-pending { background: #f59e0b; color:#1f1f1f; }
        .badge-preparing { background: #06b6d4; color:#fff; }
        .badge-ready { background: #10b981; color:#fff; }
        .badge-completed { background: #6b7280; color:#fff; }

        /* Details panel */
        .details-panel {
            width:380px;
            background: var(--bg-darker);
            border:1px solid var(--border);
            border-radius:12px;
            display:flex;
            flex-direction:column;
            max-height: calc(100vh - 48px);
            overflow:hidden;
        }

        .details-panel .p-4 { padding:1rem; }
        .details-panel .overflow-y-auto { overflow-y:auto; }

        /* form controls look */
        .form-control, .form-select {
            background: var(--bg-darker);
            color: var(--text);
            border:1px solid var(--border);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(139,92,246,0.16);
            border-color: var(--primary);
        }

        /* Utilities & responsive */
        .gap-3 { gap:12px; }
        .gap-4 { gap:16px; }
        .space-y-2 > * + * { margin-top:8px; }
        @media(max-width:900px){
            .sidebar{ width:200px; }
            main { flex-direction:column; }
            .details-panel{ width:100%; position:relative; max-height:unset; }
        }

        /* small helpers */
        .muted { color: var(--muted); }
        .text-primary { color: var(--primary); font-weight:700; }
    </style>
</head>
<body>
<div class="d-flex" style="height:100vh;">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="p-4 border-bottom" style="border-color:var(--border);">
            <h1 style="margin:0;color:var(--primary);font-size:1.25rem">RestroAdmin</h1>
            <p class="muted" style="margin:4px 0 0;font-size:.85rem">Quản Lý Đơn Hàng</p>
        </div>

        <nav style="padding:12px; display:flex; flex-direction:column; gap:8px;">
            <a href="#" id="filter-all" class="nav-link active">Tất Cả Đơn Hàng <span id="count-all" style="margin-left:auto" class="muted small"></span></a>
            <a href="#" id="filter-pending" class="nav-link">Đang Chờ <span id="count-pending" class="ms-auto badge badge-pending">0</span></a>
            <a href="#" id="filter-preparing" class="nav-link">Đang Chuẩn Bị <span id="count-preparing" class="ms-auto badge badge-preparing">0</span></a>
            <a href="#" id="filter-ready" class="nav-link">Sẵn Sàng <span id="count-ready" class="ms-auto badge badge-ready">0</span></a>
            <a href="#" id="filter-completed" class="nav-link">Hoàn Thành <span id="count-completed" class="ms-auto badge badge-completed">0</span></a>
        </nav>

        <div style="margin-top:auto;padding:12px;border-top:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="avatar">AD</div>
                <div>
                    <div style="font-weight:600">Admin</div>
                    <div class="muted" style="font-size:.85rem">Quản Lý</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-grow-1 d-flex gap-4">
        <!-- Orders list -->
        <section class="flex-grow-1 d-flex flex-column gap-4">
            <div class="d-flex align-items-center justify-content-between">
                <h2 style="margin:0;font-size:1.125rem">Đơn Hàng</h2>
                <div class="d-flex gap-2 align-items-center">
                    <input id="searchInput" type="text" placeholder="Tìm kiếm bàn hoặc ID..." class="form-control form-control-sm" style="max-width:260px;">
                    <button id="refreshBtn" class="btn btn-sm btn-primary">Refresh</button>
                </div>
            </div>

            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-sm btn-primary" data-filter="all">Tất Cả</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="pending">Đang Chờ</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="preparing">Đang Chuẩn Bị</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="ready">Sẵn Sàng</button>
                <button class="btn btn-sm btn-outline-secondary" data-filter="completed">Hoàn Thành</button>
            </div>

            <div class="orders-grid flex-grow-1 overflow-auto">
                <div id="ordersRow" class="row g-3" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;">
                    <!-- cards injected here -->
                </div>
            </div>
        </section>

        <!-- Details panel -->
        <aside id="detailsPanel" class="details-panel d-none">
            <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
                <div style="padding:1rem">
                    <h3 style="margin:0;font-size:1rem">Chi Tiết Đơn Hàng</h3>
                </div>
                <div style="padding:1rem">
                    <button id="closeDetails" class="btn btn-close" aria-label="close" style="filter:invert(1)"></button>
                </div>
            </div>

            <div class="overflow-y-auto" style="padding:1rem;">
                <div style="margin-bottom:1rem">
                    <div class="muted" style="font-size:.85rem">Thông Tin Đơn Hàng</div>
                    <div style="background:var(--bg-body);padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:8px">
                        <div style="display:flex;justify-content:space-between"><span class="muted">ID Đơn Hàng:</span> <span id="orderId" class="fw-medium">#1001</span></div>
                        <div style="display:flex;justify-content:space-between"><span class="muted">Bàn:</span> <span id="tableNumber" class="fw-medium">T-05</span></div>
                        <div style="display:flex;justify-content:space-between"><span class="muted">Số Khách:</span> <span id="guestCount" class="fw-medium">4 người</span></div>
                        <div style="display:flex;justify-content:space-between"><span class="muted">Thời Gian:</span> <span id="orderTime" class="fw-medium">12:30</span></div>
                    </div>
                </div>

                <div style="margin-bottom:1rem">
                    <div class="muted" style="font-size:.85rem">Các Mục Đặt Hàng</div>
                    <div id="itemsList" class="space-y-2" style="margin-top:8px"></div>
                </div>

                <div style="margin-bottom:1rem">
                    <div style="background:var(--bg-body);padding:12px;border-radius:8px;border:1px solid var(--border)">
                        <div style="display:flex;justify-content:space-between"><span class="muted">Tổng Cộng:</span> <span id="orderTotal" class="fw-bold text-primary">0 ₫</span></div>
                    </div>
                </div>

                <div style="margin-bottom:2rem">
                    <div class="muted" style="font-size:.85rem">Cập Nhật Trạng Thái</div>
                    <select id="statusSelect" class="form-select form-select-sm" style="margin-top:8px">
                        <option value="pending">Đang Chờ</option>
                        <option value="preparing">Đang Chuẩn Bị</option>
                        <option value="ready">Sẵn Sàng</option>
                        <option value="completed">Hoàn Thành</option>
                    </select>
                </div>
            </div>

            <div style="padding:1rem;border-top:1px solid var(--border)">
                <button id="updateStatusBtn" class="btn btn-primary w-100 mb-2">Cập Nhật Trạng Thái</button>
                <button id="deleteOrderBtn" class="btn btn-danger w-100">Xóa Đơn Hàng</button>
            </div>
        </aside>
    </main>
</div>

<!-- Dependencies: SockJS & Stomp -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /******************************************************************
     * Single-file client logic:
     * - tải danh sách từ GET /manager/orders/list
     * - realtime: subscribe /topic/orders/update via SockJS+STOMP (endpoint /ws)
     * - cập nhật trạng thái: POST /manager/orders/{orderId}/status?status=<value>
     * - xóa: gửi DELETE /manager/orders/{id} nếu API có (nếu không có thì xóa local)
     *
     * Note:
     * - Nếu Spring Security bật CSRF, server thường render meta tag _csrf & _csrf_header;
     *   script sẽ tự lấy và gửi header tương ứng.
     ******************************************************************/

        // --- State ---
    let orders = []; // will hold OrderDTO-like objects from server
    let selectedOrder = null;
    let currentFilter = 'all';
    let stompClient = null;

    // --- Helpers ---
    function money(v){
        return new Intl.NumberFormat('vi-VN').format(v) + ' ₫';
    }

    function getCsrfHeaders(){
        const metaToken = document.querySelector('meta[name="_csrf"]');
        const metaHeader = document.querySelector('meta[name="_csrf_header"]');
        if(metaToken && metaHeader){
            const name = metaHeader.getAttribute('content') || 'X-CSRF-TOKEN';
            const token = metaToken.getAttribute('content');
            const headers = {};
            headers[name] = token;
            return headers;
        }
        // also check common meta names
        const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        if(token){
            return { 'X-CSRF-TOKEN': token };
        }
        return {};
    }

    function statusBadge(status){
        switch(status){
            case 'pending': return '<span class="badge badge-pending">Đang Chờ</span>';
            case 'preparing': return '<span class="badge badge-preparing">Đang Chuẩn Bị</span>';
            case 'ready': return '<span class="badge badge-ready">Sẵn Sàng</span>';
            case 'completed': return '<span class="badge badge-completed">Hoàn Thành</span>';
            default: return '<span class="badge bg-secondary">'+status+'</span>';
        }
    }

    // --- Render functions ---
    function renderCounts(){
        const counts = { all: orders.length, pending:0, preparing:0, ready:0, completed:0 };
        orders.forEach(o=>{
            if(o.status && counts[o.status] !== undefined) counts[o.status]++;
        });
        document.getElementById('count-all').textContent = `(${counts.all})`;
        document.getElementById('count-pending').textContent = counts.pending;
        document.getElementById('count-preparing').textContent = counts.preparing;
        document.getElementById('count-ready').textContent = counts.ready;
        document.getElementById('count-completed').textContent = counts.completed;
    }

    function renderOrders(){
        const container = document.getElementById('ordersRow');
        container.innerHTML = '';
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        const filtered = orders.filter(o=>{
            if(currentFilter!=='all' && o.status !== currentFilter) return false;
            if(!q) return true;
            return ((''+o.table).toLowerCase().includes(q)) || ((''+o.id).toLowerCase().includes(q));
        });

        if(filtered.length===0){
            container.innerHTML = '<div class="p-4 muted">Không có đơn hàng phù hợp</div>';
            renderCounts();
            return;
        }

        filtered.forEach(o=>{
            const div = document.createElement('div');
            div.className = 'card-order';
            if(selectedOrder && selectedOrder.id === o.id) div.classList.add('selected');
            div.dataset.table = o.table;
            div.dataset.id = o.id;
            div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <div>
              <div class="muted" style="font-size:.85rem">Bàn</div>
              <div style="font-size:1.25rem;font-weight:700">${o.table || ''}</div>
            </div>
            <div>${statusBadge(o.status)}</div>
          </div>
          <div style="margin-bottom:8px">
            <div class="muted small">ID: <span>${o.id}</span></div>
            <div class="muted small">Thời gian: <span>${o.time || ''}</span></div>
            <div class="muted small">Khách: <span>${o.guests ?? '-'}</span></div>
          </div>
          <div style="border-top:1px solid var(--border);padding-top:8px">
            <div style="font-weight:700;color:var(--primary)">${money(o.total ?? 0)}</div>
          </div>
        `;
            div.addEventListener('click',()=> selectOrderCard(o.id));
            container.appendChild(div);
        });
        renderCounts();
    }

    function renderDetails(order){
        if(!order) return;
        document.getElementById('orderId').textContent = '#'+order.id;
        document.getElementById('tableNumber').textContent = order.table || '-';
        document.getElementById('guestCount').textContent = (order.guests ? order.guests + ' người' : '-');
        document.getElementById('orderTime').textContent = order.time || '-';
        document.getElementById('orderTotal').textContent = money(order.total || 0);
        document.getElementById('statusSelect').value = order.status || 'pending';

        // items
        const container = document.getElementById('itemsList');
        container.innerHTML = '';
        const items = order.items && order.items.length ? order.items : [];
        if(items.length===0){
            container.innerHTML = '<div class="muted">Không có mục đặt hàng</div>';
        }else{
            items.forEach(it=>{
                const el = document.createElement('div');
                el.style.background = 'var(--bg-body)';
                el.style.padding = '8px';
                el.style.borderRadius = '8px';
                el.style.display = 'flex';
                el.style.justifyContent = 'space-between';
                el.innerHTML = `<div><div style="font-weight:600">${it.name}</div><div class="muted small">x${it.qty}</div></div><div>${money(it.price)}</div>`;
                container.appendChild(el);
            });
        }
    }

    // --- Selection & UI actions ---
    function selectOrderCard(orderId){
        const order = orders.find(o=>o.id == orderId);
        if(!order) return;
        selectedOrder = order;
        // show panel
        document.getElementById('detailsPanel').classList.remove('d-none');
        renderDetails(order);
        // mark selected card
        document.querySelectorAll('.card-order').forEach(el=>el.classList.toggle('selected', el.dataset.id==orderId));
    }

    function closeDetails(){
        selectedOrder = null;
        document.getElementById('detailsPanel').classList.add('d-none');
        document.querySelectorAll('.card-order').forEach(el=>el.classList.remove('selected'));
    }

    // --- Network: fetch list ---
    async function fetchOrders(){
        try {
            const res = await fetch('/manager/orders/list');
            if(!res.ok) throw new Error('Fetch orders failed: ' + res.status);
            const data = await res.json();
            // Expecting an array of OrderDTO. Normalize a bit.
            orders = data.map(d => ({
                id: d.id ?? d.orderId ?? d.order_id,
                table: d.table ?? d.tableNumber ?? d.table_number,
                guests: d.guests ?? d.guestCount ?? d.guest_count,
                time: d.time ?? d.orderTime ?? d.timeStamp,
                status: d.status ?? 'pending',
                total: d.total ?? d.amount ?? 0,
                items: Array.isArray(d.items) ? d.items : (d.orderItems ? d.orderItems : [])
            }));
            renderOrders();
        }catch(err){
            console.error(err);
            // fallback sample dataset so UI can be tested offline
            if(orders.length===0){
                orders = [
                    { id:1001, table:'T-05', guests:4, time:'12:30', status:'pending', total:450000, items:[{name:'Phở Bò',qty:2,price:180000},{name:'Cơm Gà',qty:1,price:120000}]},
                    { id:1002, table:'T-08', guests:2, time:'12:25', status:'preparing', total:280000, items:[]},
                    { id:1003, table:'T-12', guests:6, time:'12:15', status:'ready', total:680000, items:[]},
                    { id:1004, table:'T-03', guests:3, time:'12:35', status:'pending', total:320000, items:[]},
                    { id:1005, table:'T-15', guests:5, time:'12:28', status:'preparing', total:520000, items:[]},
                    { id:1006, table:'T-07', guests:2, time:'12:00', status:'completed', total:250000, items:[]}
                ];
            }
            renderOrders();
        }
    }

    // --- Update status (server) ---
    async function updateStatus(){
        if(!selectedOrder) return alert('Vui lòng chọn đơn hàng');
        const newStatus = document.getElementById('statusSelect').value;
        const csrfHeaders = getCsrfHeaders();
        try {
            const url = `/manager/orders/${selectedOrder.id}/status`;
            const form = new URLSearchParams();
            form.set('status', newStatus);
            const res = await fetch(url, {
                method:'POST',
                headers: Object.assign({'Content-Type':'application/x-www-form-urlencoded'}, csrfHeaders),
                body: form.toString()
            });
            if(!res.ok){
                const text = await res.text();
                console.error('status update failed', res.status, text);
                throw new Error('Cập nhật thất bại');
            }
            const text = await res.text();
            if(text.includes('success')){
                // optimistic update; actual update will come through websocket too
                selectedOrder.status = newStatus;
                const idx = orders.findIndex(o=>o.id===selectedOrder.id);
                if(idx>-1) orders[idx].status = newStatus;
                renderOrders();
                renderDetails(selectedOrder);
                showToast('Cập nhật trạng thái thành công');
            } else {
                showToast('Server trả về lỗi: ' + text, true);
            }
        }catch(err){
            console.error(err);
            showToast('Cập nhật thất bại. Kiểm tra console.', true);
        }
    }

    // --- Delete order (attempt DELETE, fallback client-side) ---
    async function deleteOrder(){
        if(!selectedOrder) return;
        if(!confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) return;
        const csrfHeaders = getCsrfHeaders();
        try {
            const url = `/manager/orders/${selectedOrder.id}`;
            const res = await fetch(url, { method:'DELETE', headers: csrfHeaders });
            if(res.ok){
                orders = orders.filter(o=>o.id !== selectedOrder.id);
                closeDetails();
                renderOrders();
                showToast('Xóa đơn hàng thành công');
                return;
            }
            // if DELETE not implemented, fallback to local removal
            console.warn('DELETE returned', res.status);
        }catch(err){
            console.warn('DELETE failed, fallback to local removal', err);
        }
        // fallback local
        orders = orders.filter(o=>o.id !== selectedOrder.id);
        closeDetails();
        renderOrders();
        showToast('Đã xóa cục bộ (server có thể không hỗ trợ DELETE)');
    }

    // --- Realtime: connect SockJS+STOMP ---
    function connectRealtime(){
        try {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            // Optionally disable debug logs:
            stompClient.debug = null;

            stompClient.connect({}, function(frame){
                console.log('Connected to STOMP:', frame);
                stompClient.subscribe('/topic/orders/update', function(message){
                    try {
                        const dto = JSON.parse(message.body);
                        // convert dto to local order shape
                        const update = {
                            id: dto.id ?? dto.orderId ?? dto.order_id,
                            table: dto.table ?? dto.tableNumber ?? dto.table_number,
                            guests: dto.guests ?? dto.guestCount ?? dto.guest_count,
                            time: dto.time ?? dto.orderTime ?? dto.timeStamp,
                            status: dto.status ?? 'pending',
                            total: dto.total ?? dto.amount ?? 0,
                            items: Array.isArray(dto.items) ? dto.items : (dto.orderItems ? dto.orderItems : [])
                        };
                        // upsert
                        const idx = orders.findIndex(o=>o.id == update.id);
                        if(idx>-1){
                            orders[idx] = Object.assign({}, orders[idx], update);
                        }else{
                            orders.unshift(update); // new order: add to top
                        }
                        renderOrders();
                        // if currently viewing details of same order, refresh detail view
                        if(selectedOrder && selectedOrder.id == update.id){
                            selectedOrder = orders.find(o=>o.id == update.id);
                            renderDetails(selectedOrder);
                        }
                        // small toast
                        showToast('Đơn hàng #' + update.id + ' đã được cập nhật (realtime)');
                    }catch(e){
                        console.error('Failed to handle stomp message', e);
                    }
                });
            }, function(err){
                console.error('STOMP connect error', err);
                // try reconnect after delay
                setTimeout(connectRealtime, 5000);
            });
        }catch(e){
            console.error('Realtime init failed', e);
        }
    }

    // --- UI helpers ---
    function showToast(message, isError=false){
        // basic temporary toast using alert-like visual
        const el = document.createElement('div');
        el.textContent = message;
        el.style.position = 'fixed';
        el.style.right = '16px';
        el.style.bottom = '16px';
        el.style.padding = '12px 16px';
        el.style.borderRadius = '8px';
        el.style.background = isError ? '#dc2626' : 'rgba(20,20,20,0.9)';
        el.style.color = '#fff';
        el.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';
        document.body.appendChild(el);
        setTimeout(()=> el.style.opacity = '0.0', 2200);
        setTimeout(()=> el.remove(), 2600);
    }

    // --- Event wiring ---
    document.getElementById('closeDetails').addEventListener('click', closeDetails);
    document.getElementById('updateStatusBtn').addEventListener('click', updateStatus);
    document.getElementById('deleteOrderBtn').addEventListener('click', deleteOrder);
    document.getElementById('refreshBtn').addEventListener('click', fetchOrders);

    // search input
    document.getElementById('searchInput').addEventListener('input', ()=> renderOrders());

    // filter buttons (top)
    document.querySelectorAll('[data-filter]').forEach(b=>{
        b.addEventListener('click', (e)=>{
            document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('btn-primary'));
            document.querySelectorAll('[data-filter]').forEach(x=>x.classList.add('btn-outline-secondary'));
            b.classList.remove('btn-outline-secondary');
            b.classList.add('btn-primary');
            currentFilter = b.dataset.filter;
            renderOrders();
        });
    });

    // sidebar filters
    ['all','pending','preparing','ready','completed'].forEach(f=>{
        const el = document.getElementById('filter-'+f);
        if(el) el.addEventListener('click', (ev)=>{
            ev.preventDefault();
            currentFilter = f==='all' ? 'all' : f;
            document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            renderOrders();
        });
    });

    // init
    (function init(){
        fetchOrders();
        connectRealtime();
    })();
</script>
    </body>
</html>